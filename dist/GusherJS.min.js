!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Gusher=e():t.Gusher=e()}(this,function(){return function(t){function e(i){if(n[i])return n[i].exports;var r=n[i]={exports:{},id:i,loaded:!1};return t[i].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function i(t){return t&&t.__esModule?t:{"default":t}}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0;var o=n(1),s=i(o),c=n(6),u=i(c),a=n(4),h=i(a),l=n(2),f=i(l),p=function(){function t(){var e=this,n=arguments.length<=0||void 0===arguments[0]?"":arguments[0],i=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];r(this,t),this.key=n,this.options=i,i.level&&f["default"].setLevel(i.level),this.emitter=new s["default"],this.channels=new h["default"],this.connection=new u["default"](this.key,this.options),this.connection.bind("connected",function(){e.subscribeAll()}),this.connection.bind("message",function(t){if(t.channel){var n=e.channel(t.channel);n&&n.handleEvent(t.event,t.data)}e.emitter.emit(t.event,t.data),e.emitter.emit("*",t)}),this.connection.bind("disconnected",function(){e.channels.disconnect()}),this.connection.bind("error",function(t){f["default"].error("Error",t)})}return t.prototype.channel=function(t){return this.channels.find(t)},t.prototype.allChannel=function(){return this.channels.all()},t.prototype.connect=function(){this.connection.connect()},t.prototype.disconnect=function(){this.connection.disconnect()},t.prototype.bind=function(t,e){return this.emitter.on(t,e),this},t.prototype.unbind=function(t,e){return this.emitter.removeListener(t,e),this},t.prototype.subscribe=function(t){var e=this.channels.add(t,this);return"connected"===this.connection.state&&e.subscribe(),e},t.prototype.subscribeAll=function(){var t=this;this.channels.channels.forEach(function(e,n){t.subscribe(n)})},t.prototype.unsubscribe=function(t){var e=this.channels.remove(t);e&&"connected"===this.connection.state&&e.unsubscribe()},t.prototype.send=function(t,e,n){this.connection.send(t,e,n)},t}();e["default"]=p,t.exports=e["default"]},function(t,e){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(t){return"function"==typeof t}function r(t){return"number"==typeof t}function o(t){return"object"==typeof t&&null!==t}function s(t){return void 0===t}t.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(t){if(!r(t)||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},n.prototype.emit=function(t){var e,n,r,c,u,a;if(this._events||(this._events={}),"error"===t&&(!this._events.error||o(this._events.error)&&!this._events.error.length)){if(e=arguments[1],e instanceof Error)throw e;var h=new Error('Uncaught, unspecified "error" event. ('+e+")");throw h.context=e,h}if(n=this._events[t],s(n))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:c=Array.prototype.slice.call(arguments,1),n.apply(this,c)}else if(o(n))for(c=Array.prototype.slice.call(arguments,1),a=n.slice(),r=a.length,u=0;u<r;u++)a[u].apply(this,c);return!0},n.prototype.addListener=function(t,e){var r;if(!i(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,i(e.listener)?e.listener:e),this._events[t]?o(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,o(this._events[t])&&!this._events[t].warned&&(r=s(this._maxListeners)?n.defaultMaxListeners:this._maxListeners,r&&r>0&&this._events[t].length>r&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace())),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(t,e){function n(){this.removeListener(t,n),r||(r=!0,e.apply(this,arguments))}if(!i(e))throw TypeError("listener must be a function");var r=!1;return n.listener=e,this.on(t,n),this},n.prototype.removeListener=function(t,e){var n,r,s,c;if(!i(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(n=this._events[t],s=n.length,r=-1,n===e||i(n.listener)&&n.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(o(n)){for(c=s;c-- >0;)if(n[c]===e||n[c].listener&&n[c].listener===e){r=c;break}if(r<0)return this;1===n.length?(n.length=0,delete this._events[t]):n.splice(r,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},n.prototype.removeAllListeners=function(t){var e,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[t],i(n))this.removeListener(t,n);else if(n)for(;n.length;)this.removeListener(t,n[n.length-1]);return delete this._events[t],this},n.prototype.listeners=function(t){var e;return e=this._events&&this._events[t]?i(this._events[t])?[this._events[t]]:this._events[t].slice():[]},n.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(i(e))return 1;if(e)return e.length}return 0},n.listenerCount=function(t,e){return t.listenerCount(e)}},function(t,e,n){"use strict";function i(t){return t&&t.__esModule?t:{"default":t}}e.__esModule=!0;var r=n(7),o=i(r);e["default"]=o["default"].getLogger("Gusher"),t.exports=e["default"]},function(t,e,n){"use strict";function i(t){return t&&t.__esModule?t:{"default":t}}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0;var o=n(1),s=i(o),c=function(){function t(e,n){r(this,t),this.name=e,this.gusher=n,this.subscribed=!1,this.emitter=new s["default"]}return t.prototype.trigger=function(t,e){return this.gusher.send(t,e,this.name)},t.prototype.disconnect=function(){this.subscribed=!0},t.prototype.bind=function(t,e){return this.emitter.on(t,e),this},t.prototype.unbind=function(t,e){return this.emitter.removeListener(t,e),this},t.prototype.handleEvent=function(t,e){"subscribe_succeeded"===t&&(this.subscribed=!0),this.emitter.emit(t,e)},t.prototype.subscribe=function(){this.gusher.send("gusher.subscribe",{id:"todo",channel:this.name})},t.prototype.unsubscribe=function(){this.gusher.send("gusher.unsubscribe",{id:"todo",channel:this.name})},t}();e["default"]=c,t.exports=e["default"]},function(t,e,n){"use strict";function i(t){return t&&t.__esModule?t:{"default":t}}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0;var o=n(3),s=i(o),c=function(){function t(){r(this,t),this.channels=new Map}return t.prototype.add=function(t,e){var n=this.channels.get(t);return n||(n=new s["default"](t,e),this.channels.set(t,n)),n},t.prototype.find=function(t){return this.channels.get(t)},t.prototype.remove=function(t){var e=this.channels.get(t);return this.channels["delete"](t),e},t.prototype.all=function(){for(var t=[],e=this.channels.keys(),n=Array.isArray(e),i=0,e=n?e:e[Symbol.iterator]();;){var r;if(n){if(i>=e.length)break;r=e[i++]}else{if(i=e.next(),i.done)break;r=i.value}var o=r;t.push(o)}return t},t.prototype.disconnect=function(){this.channels.forEach(function(t){return t.disconnect()})},t}();e["default"]=c,t.exports=e["default"]},function(t,e,n){"use strict";function i(t){return t&&t.__esModule?t:{"default":t}}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0;var o=n(1),s=i(o),c=n(2),u=i(c),a=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];r(this,t),this.url=e.url||"",this.state="initialized",this.emitter=new s["default"]}return t.prototype.bind=function(t,e){return this.emitter.on(t,e),this},t.prototype.unbind=function(t,e){return this.emitter.removeListener(t,e),this},t.prototype.connect=function(){if(this.socket)return!1;try{this.socket=new WebSocket(this.url)}catch(t){return!1}return this.bindListeners(),u["default"].debug("Connecting",{url:this.url}),this.changeState("connecting"),!0},t.prototype.close=function(){return!!this.socket&&(this.socket.close(),!0)},t.prototype.changeState=function(t,e){this.state=t,this.emitter.emit(t,e)},t.prototype.bindListeners=function(){var t=this;this.socket.onopen=function(){t.onOpen()},this.socket.onerror=function(e){t.onError(e)},this.socket.onclose=function(e){t.onClose(e)},this.socket.onmessage=function(e){t.onMessage(e)}},t.prototype.unbindListeners=function(){this.socket&&(this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null,this.socket.onmessage=null)},t.prototype.onOpen=function(){this.changeState("open"),this.socket.onopen=null},t.prototype.onError=function(t){this.emitter.emit("error",t)},t.prototype.onClose=function(t){t?this.changeState("closed",{code:t.code,reason:t.reason,wasClean:t.wasClean}):this.changeState("closed"),this.unbindListeners(),this.socket=null},t.prototype.onMessage=function(t){var e=void 0;try{e=JSON.parse(t.data)}catch(n){return u["default"].error({error:n}),void this.emitter("error",{error:n})}e&&(u["default"].debug("Event recd",e),this.emitter.emit("message",e))},t.prototype.send=function(t,e,n){var i={event:t,data:e};this.channel&&(i.channel=n),u["default"].debug("Event sent",i),this.socket.send(JSON.stringify(i))},t}();e["default"]=a,t.exports=e["default"]},function(t,e,n){"use strict";function i(t){return t&&t.__esModule?t:{"default":t}}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0;var o=n(1),s=i(o),c=n(5),u=i(c),a=n(2),h=i(a),l=function(){function t(){var e=this,n=arguments.length<=0||void 0===arguments[0]?"":arguments[0],i=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];r(this,t),this.key=n,this.options=i,this.state="initialized",this.emitter=new s["default"],this.reconnection=i.reconnection||!0,this.reconnectionDelay=i.reconnectionDelay||1e3,this.skipReconnect=!1,this.retryNum=0,this.retryTimer=null,this.connection=new u["default"](this.options),this.connection.bind("open",function(){e.retryTimer&&(clearTimeout(e.retryTimer),e.retryNum=0,e.retryTimer=null),e.skipReconnect=!1,e.updateState("connected")}),this.connection.bind("message",function(t){e.emitter.emit("message",t)}),this.connection.bind("error",function(t){e.updateState("error",t)}),this.connection.bind("closed",function(t){e.updateState("closed",t),e.retryIn(e.reconnectionDelay)}),this.connect()}return t.prototype.retryIn=function(){var t=this,e=arguments.length<=0||void 0===arguments[0]?0:arguments[0];this.reconnection&&!this.skipReconnect&&(this.retryTimer=setTimeout(function(){t.retryNum++,h["default"].debug("Reconnect attempts: ",t.retryNum),t.connect(),t.retryTimer=null},e))},t.prototype.bind=function(t,e){return this.emitter.on(t,e),this},t.prototype.unbind=function(t,e){return this.emitter.removeListener(t,e),this},t.prototype.connect=function(){this.updateState("connecting"),this.connection.connect()},t.prototype.disconnect=function(){this.skipReconnect=!0,this.connection.close(),this.updateState("disconnected")},t.prototype.updateState=function(t,e){var n=this.state;this.state=t,n!==t&&(h["default"].debug("State changed",n+" -> "+t),this.emitter.emit("state_change",{previous:n,current:t}),this.emitter.emit(t,e))},t.prototype.send=function(t,e,n){return!!this.connection&&this.connection.send(t,e,n)},t}();e["default"]=l,t.exports=e["default"]},function(t,e,n){!function(e,n){t.exports=n()}(this,function(){return function(t){function e(i){if(n[i])return n[i].exports;var r=n[i]={exports:{},id:i,loaded:!1};return t[i].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function i(t){return t&&t.__esModule?t:{"default":t}}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0;var o=n(1),s=i(o),c=function(){function t(){r(this,t)}return t.prototype.getLogger=function(t){var e=new s["default"](t);return e},t}();e["default"]=new c,t.exports=e["default"]},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t){return"string"==typeof t}function r(t,e){var n=""+t;return n.length>=e?n:r("0"+n,e)}function o(){var t=new Date;return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+" "+r(t.getHours(),2)+":"+r(t.getMinutes(),2)+":"+r(t.getSeconds(),2)+":"+t.getMilliseconds()}e.__esModule=!0;var s=e.LEVEL_MAP={DEBUG:1,INFO:2,WARN:3,ERROR:4,FATAL:5},c=e.LEVEL_KEY={1:"DEBUG",2:"INFO",3:"WARN",4:"ERROR",5:"FATAL"},u=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?"LOG":arguments[0],i=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];n(this,t),this.name=e,this.level=s[i.level]||s.INFO}return t.prototype.setLevel=function(t){s[t]&&(this.level=s[t])},t.prototype.debug=function(t){if(i(t)){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];this.write(s.DEBUG,t,n)}},t.prototype.info=function(t){if(i(t)){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];this.write(s.INFO,t,n)}},t.prototype.warn=function(t){if(i(t)){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];this.write(s.WARN,t,n)}},t.prototype.error=function(t){if(i(t)){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];this.write(s.ERROR,t,n)}},t.prototype.fatal=function(t){if(i(t)){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];this.write(s.FATAL,t,n)}},t.prototype.write=function(t,e,n){if(t>=this.level&&i(e)){var r=console[c[t].toLowerCase()]?console[c[t].toLowerCase()]:console.log;r.apply(void 0,["["+o()+"] ["+c[t]+"] "+this.name+" - "+e].concat(n))}},t}();e["default"]=u}])})}])});