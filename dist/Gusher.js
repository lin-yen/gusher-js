!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Gusher=t():e.Gusher=t()}(window,function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=7)}([function(e,t){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(e){return"function"==typeof e}function r(e){return"object"==typeof e&&null!==e}function s(e){return void 0===e}e.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},n.prototype.emit=function(e){var t,n,o,c,u,a;if(this._events||(this._events={}),"error"===e&&(!this._events.error||r(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}if(s(n=this._events[e]))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:c=Array.prototype.slice.call(arguments,1),n.apply(this,c)}else if(r(n))for(c=Array.prototype.slice.call(arguments,1),o=(a=n.slice()).length,u=0;u<o;u++)a[u].apply(this,c);return!0},n.prototype.addListener=function(e,t){var o;if(!i(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?r(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,r(this._events[e])&&!this._events[e].warned&&(o=s(this._maxListeners)?n.defaultMaxListeners:this._maxListeners)&&o>0&&this._events[e].length>o&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(e,t){if(!i(t))throw TypeError("listener must be a function");var n=!1;function r(){this.removeListener(e,r),n||(n=!0,t.apply(this,arguments))}return r.listener=t,this.on(e,r),this},n.prototype.removeListener=function(e,t){var n,s,o,c;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(o=(n=this._events[e]).length,s=-1,n===t||i(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(r(n)){for(c=o;c-- >0;)if(n[c]===t||n[c].listener&&n[c].listener===t){s=c;break}if(s<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(s,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},n.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(i(n=this._events[e]))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},n.prototype.listeners=function(e){return this._events&&this._events[e]?i(this._events[e])?[this._events[e]]:this._events[e].slice():[]},n.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(i(t))return 1;if(t)return t.length}return 0},n.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,r=n(4),s=(i=r)&&i.__esModule?i:{default:i};t.default=s.default.getLogger("Gusher")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(0),o=(i=s)&&i.__esModule?i:{default:i};var c=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=t,this.gusher=n,this.subscribed=!1,this.emitter=new o.default}return r(e,[{key:"trigger",value:function(e,t){return this.gusher.send(e,t,this.name)}},{key:"disconnect",value:function(){this.subscribed=!0}},{key:"bind",value:function(e,t){return this.emitter.on(e,t),this}},{key:"unbind",value:function(e,t){return this.emitter.removeListener(e,t),this}},{key:"handleEvent",value:function(e,t){"gusher.subscribe_succeeded"!==e&&"gusher.multi_subscribe_succeeded"!==e||(this.subscribed=!0),this.emitter.emit(e,t)}},{key:"subscribe",value:function(){this.gusher.send("gusher.subscribe",{channel:this.name})}},{key:"unsubscribe",value:function(){this.gusher.send("gusher.unsubscribe",{channel:this.name})}}]),e}();t.default=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(2),o=(i=s)&&i.__esModule?i:{default:i};var c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.channels=new Map}return r(e,[{key:"add",value:function(e,t){var n=this.channels.get(e);return n||(n=new o.default(e,t),this.channels.set(e,n)),n}},{key:"find",value:function(e){return this.channels.get(e)}},{key:"remove",value:function(e){var t=this.channels.get(e);return this.channels.delete(e),t}},{key:"all",value:function(){var e=[],t=!0,n=!1,i=void 0;try{for(var r,s=this.channels.keys()[Symbol.iterator]();!(t=(r=s.next()).done);t=!0){var o=r.value;e.push(o)}}catch(e){n=!0,i=e}finally{try{!t&&s.return&&s.return()}finally{if(n)throw i}}return e}},{key:"disconnect",value:function(){this.channels.forEach(function(e){return e.disconnect()})}}]),e}();t.default=c},function(e,t,n){"undefined"!=typeof self&&self,e.exports=function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){e.exports=n(1)},function(e,t){function n(e,t){const i=""+e;return i.length>=t?i:n("0"+i,t)}function i(e,t){this.name=e||"Log4js",this.options=t||{},this.level=r[this.options.level]||r.INFO}const r={DEBUG:"DEBUG",INFO:"INFO",WARN:"WARN",ERROR:"ERROR",FATAL:"FATAL"};i.prototype.setLevel=function(e){r[e]&&(this.level=r[e])},i.prototype.debug=function(){this.write(r.DEBUG,[].slice.call(arguments))},i.prototype.info=function(){this.write(r.INFO,[].slice.call(arguments))},i.prototype.warn=function(){this.write(r.WARN,[].slice.call(arguments))},i.prototype.error=function(){this.write(r.ERROR,[].slice.call(arguments))},i.prototype.fatal=function(){this.write(r.FATAL,[].slice.call(arguments))},i.prototype.write=function(){const e=arguments[0],t=arguments[1];if(e>=this.level){const i=t.slice(1);let s=["["+function(){let e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+n(e.getHours(),2)+":"+n(e.getMinutes(),2)+":"+n(e.getSeconds(),2)+":"+e.getMilliseconds()}()+"] "+r[e]+" "+this.name+" - "+t[0]+"   "];t.length>1&&(s=s.concat(i)),console.log.apply(console.log,s)}},i.getLogger=function(e,t){return new i(e,t)},e.exports=i}])},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=o(n(0)),s=o(n(1));function o(e){return e&&e.__esModule?e:{default:e}}var c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.url=t.url||"",this.token=t.token||"",this.state="initialized",this.emitter=new r.default}return i(e,[{key:"bind",value:function(e,t){return this.emitter.on(e,t),this}},{key:"unbind",value:function(e,t){return this.emitter.removeListener(e,t),this}},{key:"connect",value:function(e){this.socket&&this.close();var t=this.url;e&&(t=t+"?token="+e);try{this.socket=new WebSocket(t)}catch(e){return this.onError(e),!1}return this.bindListeners(),s.default.debug("Connecting",{url:this.url,token:this.token}),this.changeState("connecting"),!0}},{key:"close",value:function(){return!!this.socket&&(this.socket.close(),this.socket=null,!0)}},{key:"changeState",value:function(e,t){this.state=e,this.emitter.emit(e,t)}},{key:"bindListeners",value:function(){var e=this;this.socket.onopen=function(){e.onOpen()},this.socket.onerror=function(t){e.onError(t)},this.socket.onclose=function(t){e.onClose(t)},this.socket.onmessage=function(t){e.onMessage(t)}}},{key:"unbindListeners",value:function(){this.socket&&(this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null,this.socket.onmessage=null)}},{key:"onOpen",value:function(){this.changeState("open"),this.socket.onopen=null}},{key:"onError",value:function(e){this.emitter.emit("error",e)}},{key:"onClose",value:function(e){e?this.changeState("closed",{code:e.code,reason:e.reason,wasClean:e.wasClean}):this.changeState("closed"),this.unbindListeners(),this.socket=null}},{key:"onMessage",value:function(e){var t=void 0;try{t=JSON.parse(e.data)}catch(e){return s.default.error({error:e}),void this.emitter("error",{error:e})}t&&(s.default.debug("Event recd",t),this.emitter.emit("message",t))}},{key:"send",value:function(e,t,n){var i={event:e,data:t};this.channel&&(i.channel=n),s.default.debug("Event sent",i),this.socket&&this.socket.send(JSON.stringify(i))}}]),e}();t.default=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=c(n(0)),s=c(n(5)),o=c(n(1));function c(e){return e&&e.__esModule?e:{default:e}}var u=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.key=n,this.state="initialized",this.url=i.url,this.token=i.token,this.emitter=new r.default,this.reconnection=void 0===i.reconnection||i.reconnection,this.reconnectionDelay=void 0===i.reconnectionDelay?3e3:i.reconnectionDelay,this.retryMax=void 0===i.retryMax?Number.MAX_SAFE_INTEGER:i.retryMax,this.skipReconnect=!1,this.retryNum=0,this.connectionStartTimestamp=0,this.retryTimer=null,this.connection=new s.default({url:this.url,token:this.token}),this.connection.bind("open",function(){t.connectionStartTimestamp=Date.now(),t.retryTimer&&(clearTimeout(t.retryTimer),t.retryNum=0,t.retryTimer=null),t.skipReconnect=!1,t.updateState("connected")}),this.connection.bind("message",function(e){t.emitter.emit("message",e)}),this.connection.bind("error",function(e){t.updateState("error",e)}),this.connection.bind("closed",function(e){var n=Date.now()-t.connectionStartTimestamp;n>0&&0!==t.connectionStartTimestamp&&(t.emitter.emit("@closed",Object.assign({},e,{session_time:n})),o.default.debug("Session Time: "+n+" ms"),t.connectionStartTimestamp=0),t.updateState("closed",e),t.retryIn(t.reconnectionDelay)})}return i(e,[{key:"retryIn",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.retryNum>=this.retryMax&&(this.disconnect(),this.emitter.emit("retryMax"),o.default.debug("Reconnect Max: ",this.retryNum)),this.reconnection&&!this.skipReconnect&&(this.retryTimer=setTimeout(function(){e.retryNum+=1,o.default.debug("Reconnect attempts: ",e.retryNum),e.connect(),e.emitter.emit("retry",{retry:e.retryNum})},t))}},{key:"bind",value:function(e,t){return this.emitter.on(e,t),this}},{key:"unbind",value:function(e,t){return this.emitter.removeListener(e,t),this}},{key:"unBindAll",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];t.length?this.emitter.removeAllListeners(t):this.emitter.removeAllListeners()}},{key:"connect",value:function(){this.updateState("connecting"),this.connection.connect(this.token),o.default.debug("Auth",{token:this.token})}},{key:"disconnect",value:function(){this.skipReconnect=!0,this.connection.close(),this.updateState("disconnected")}},{key:"updateState",value:function(e,t){var n=this.state;this.state=e,n!==e&&(o.default.debug("State changed","'"+n+"' -> '"+e+"'"),this.emitter.emit("state_change",{previous:n,current:e}),this.emitter.emit(e,t))}},{key:"send",value:function(e,t,n){return!!this.connection&&this.connection.send(e,t,n)}}]),e}();t.default=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=u(n(0)),s=u(n(6)),o=u(n(3)),c=u(n(1));function u(e){return e&&e.__esModule?e:{default:e}}var a=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.key=t,this.options=n,n.level&&c.default.setLevel(n.level),this.emitter=new r.default,this.channels=new o.default,this.connection=this.createConnection()}return i(e,[{key:"getAuthToken",value:function(){return this.options.token||""}},{key:"setAuthToken",value:function(e){e&&(this.options.token=e,this.connection.unBindAll(),this.connection.disconnect(),this.connection=this.createConnection())}},{key:"createConnection",value:function(){var e=this,t=new s.default(this.key,this.options);return t.bind("connected",function(){e.subscribeAll(),e.emitter.emit("connected")}),t.bind("message",function(t){if(t){if(t.channel){var n=e.channels.find(t.channel);n&&n.handleEvent(t.event,t.data)}t.data&&t.data.channel&&Array.isArray(t.data.channel)&&t.data.channel.forEach(function(n){var i=e.channels.find(n);i&&i.handleEvent(t.event,t.data)}),e.emitter.emit(t.event,t.data),e.emitter.emit("*",t)}}),t.bind("disconnected",function(){e.channels.disconnect(),e.emitter.emit("disconnected")}),t.bind("retry",function(t){e.emitter.emit("retry",t)}),t.bind("retryMax",function(){e.emitter.emit("retryMax")}),t.bind("@closed",function(t){e.emitter.emit("@closed",t)}),t.bind("closed",function(t){e.emitter.emit("closed",t)}),t.bind("error",function(t){c.default.error("Error",t),e.emitter.emit("error",t)}),t}},{key:"channel",value:function(e){return this.channels.find(e)}},{key:"allChannel",value:function(){return this.channels.all()}},{key:"connect",value:function(){this.connection.connect()}},{key:"disconnect",value:function(){this.connection.disconnect()}},{key:"bind",value:function(e,t){return this.emitter.on(e,t),this}},{key:"unbind",value:function(e,t){return this.emitter.removeListener(e,t),this}},{key:"subscribe",value:function(e){var t=this.channels.add(e,this);return"connected"===this.connection.state&&t.subscribe(),t}},{key:"subscribes",value:function(e){var t=this;if(Array.isArray(e)){var n={};return e.forEach(function(e){n[e]=t.channels.add(e,t)}),"connected"===this.connection.state&&this.subscribeAll(e),n}}},{key:"subscribeAll",value:function(e){var t=e||this.channels.all();this.send("gusher.multi_subscribe",{multi_channel:t})}},{key:"unsubscribe",value:function(e){var t=this.channels.remove(e);t&&"connected"===this.connection.state&&t.unsubscribe()}},{key:"send",value:function(e,t,n){this.connection.send(e,t,n)}}]),e}();t.default=a}])});